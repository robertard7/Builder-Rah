openapi: 3.0.1
info:
  title: Builder-Rah Headless API
  version: "1.0.0"
servers:
  - url: http://localhost:5050
paths:
  /sessions:
    get:
      summary: List sessions
      responses:
        "200":
          description: Sessions list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SessionSummary"
    post:
      summary: Create session
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionSummary"
  /sessions/{id}:
    get:
      summary: Get session metadata
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Session metadata
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionSummary"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
    delete:
      summary: Delete session
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  sessionId:
                    type: string
  /sessions/{id}/status:
    get:
      summary: Get session status
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Status
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessionId:
                    type: string
                  status:
                    $ref: "#/components/schemas/SessionStatus"
                  resilienceSummary:
                    type: string
                    description: Summary of resilience metrics at time of request.
                  resilience:
                    $ref: "#/components/schemas/ResilienceMetrics"
                  resilienceByTool:
                    $ref: "#/components/schemas/ResilienceMetricsByTool"
                  resilienceAlerts:
                    type: array
                    items:
                      $ref: "#/components/schemas/ResilienceAlertEvent"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
              examples:
                notFound:
                  value:
                    code: not_found
                    message: not_found
  /sessions/{id}/plan:
    get:
      summary: Get pending plan
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Plan
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessionId:
                    type: string
                  plan:
                    type: object
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /sessions/{id}/messages:
    get:
      summary: Get session messages
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Messages
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SessionMessage"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /sessions/{id}/message:
    post:
      summary: Send message
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                text:
                  type: string
      responses:
        "200":
          description: Response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionRunResponse"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
              examples:
                badRequest:
                  value:
                    code: bad_request
                    message: text_required
        "503":
          description: Circuit open
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
              examples:
                circuitOpen:
                  value:
                    code: service_unavailable
                    message: circuit_open
                    details:
                      retryAfterSeconds: 30
                      hint: The circuit breaker is open. Retry after backoff.
                      circuitState: open
                      endpoint: /sessions/abc123/message
                      errorCode: circuit_open
  /sessions/{id}/attachments:
    post:
      summary: Add attachment
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                path:
                  type: string
      responses:
        "200":
          description: Attachment result
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  message:
                    type: string
                  added:
                    type: array
                    items:
                      $ref: "#/components/schemas/SessionAttachment"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /sessions/{id}/run:
    post:
      summary: Run plan
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Execution response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionRunResponse"
        "503":
          description: Circuit open
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
              examples:
                circuitOpen:
                  value:
                    code: service_unavailable
                    message: circuit_open
                    details:
                      retryAfterSeconds: 30
                      hint: The circuit breaker is open. Retry after backoff.
                      circuitState: open
                      endpoint: /sessions/abc123/run
                      errorCode: circuit_open
  /sessions/{id}/cancel:
    post:
      summary: Cancel plan
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Cancelled
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessionId:
                    type: string
                  status:
                    type: object
  /provider/metrics:
    get:
      summary: Provider metrics
      responses:
        "200":
          description: Metrics
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProviderMetrics"
  /metrics/resilience:
    get:
      summary: Resilience metrics
      parameters:
        - name: state
          in: query
          required: false
          schema:
            $ref: "#/components/schemas/ResilienceState"
        - name: minRetryAttempts
          in: query
          required: false
          schema:
            type: integer
      responses:
        "200":
          description: Resilience metrics
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResilienceMetrics"
        "204":
          description: No matching metrics
        "400":
          description: Invalid filter
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /metrics/resilience/history:
    get:
      summary: Resilience metrics history
      parameters:
        - name: minutes
          in: query
          required: false
          schema:
            type: integer
        - name: start
          in: query
          required: false
          schema:
            type: string
            format: date-time
        - name: end
          in: query
          required: false
          schema:
            type: string
            format: date-time
        - name: page
          in: query
          required: false
          schema:
            type: integer
        - name: perPage
          in: query
          required: false
          schema:
            type: integer
        - name: limit
          in: query
          required: false
          schema:
            type: integer
        - name: bucketMinutes
          in: query
          required: false
          schema:
            type: integer
      responses:
        "200":
          description: Resilience history
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResilienceHistoryResponse"
        "400":
          description: Invalid date range
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /metrics/resilience/reset:
    put:
      summary: Reset resilience metrics
      responses:
        "200":
          description: Reset
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  resetAt:
                    type: string
                    format: date-time
    post:
      summary: Reset resilience metrics
      responses:
        "200":
          description: Reset
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  resetAt:
                    type: string
                    format: date-time
  /alerts/thresholds:
    post:
      summary: Create alert threshold rule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ResilienceAlertRuleRequest"
      responses:
        "201":
          description: Rule created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResilienceAlertRule"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /alerts:
    post:
      summary: Create alert rule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ResilienceAlertRuleRequest"
      responses:
        "201":
          description: Rule created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResilienceAlertRule"
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
    get:
      summary: List alert rules and recent events
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
        - name: severity
          in: query
          required: false
          schema:
            type: string
            enum: [warning, critical]
        - name: includeAcknowledged
          in: query
          required: false
          schema:
            type: boolean
      responses:
        "200":
          description: Alerts
          content:
            application/json:
              schema:
                type: object
                properties:
                  rules:
                    type: array
                    items:
                      $ref: "#/components/schemas/ResilienceAlertRuleSummary"
                  events:
                    type: array
                    items:
                      $ref: "#/components/schemas/ResilienceAlertEvent"
    delete:
      summary: Delete alert rules
      parameters:
        - name: ruleId
          in: query
          required: false
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  ruleId:
                    type: string
  /alerts/{id}:
    patch:
      summary: Update alert rule
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ResilienceAlertRuleUpdate"
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResilienceAlertRule"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /alerts/events/{id}:
    patch:
      summary: Acknowledge alert event
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                acknowledged:
                  type: boolean
                resolved:
                  type: boolean
      responses:
        "200":
          description: Updated event
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResilienceAlertEvent"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiError"
  /healthz:
    get:
      summary: Health check
      responses:
        "200":
          description: Health
  /readyz:
    get:
      summary: Readiness check
      responses:
        "200":
          description: Readiness
  /provider/events:
    get:
      summary: Provider events
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
        - name: offset
          in: query
          required: false
          schema:
            type: integer
      responses:
        "200":
          description: Events
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/ProviderEvent"
components:
  schemas:
    ApiError:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: object
      example:
        code: bad_request
        message: invalid_state
        details:
          errorCode: invalid_state
    SessionSummary:
      type: object
      properties:
        sessionId:
          type: string
        lastTouched:
          type: string
          format: date-time
        resilienceSummary:
          type: string
          description: Summary of resilience metrics at time of request.
        resilience:
          $ref: "#/components/schemas/ResilienceMetrics"
    SessionMessage:
      type: object
      properties:
        sender:
          type: string
        text:
          type: string
        timestamp:
          type: string
          format: date-time
    SessionAttachment:
      type: object
      properties:
        storedName:
          type: string
        originalName:
          type: string
        kind:
          type: string
        sizeBytes:
          type: integer
        sha256:
          type: string
        active:
          type: boolean
    SessionStatus:
      type: object
      properties:
        status:
          type: string
        display:
          type: string
    SessionRunResponse:
      type: object
      properties:
        sessionId:
          type: string
        responses:
          type: array
          items:
            type: string
        status:
          type: object
    ProviderMetrics:
      type: object
      additionalProperties: true
    ResilienceMetrics:
      type: object
      readOnly: true
      properties:
        openCount:
          type: integer
          readOnly: true
          description: OpenCount (number of circuits opened)
        halfOpenCount:
          type: integer
          readOnly: true
          description: HalfOpenCount (number of circuits half-opened)
        closedCount:
          type: integer
          readOnly: true
          description: ClosedCount (number of circuits closed)
        retryAttempts:
          type: integer
          readOnly: true
          description: RetryAttempts (number of retry attempts recorded)
      example:
        openCount: 1
        halfOpenCount: 0
        closedCount: 5
        retryAttempts: 3
    ResilienceState:
      type: string
      enum:
        - open
        - halfopen
        - closed
    ResilienceMetricsByTool:
      type: object
      additionalProperties:
        $ref: "#/components/schemas/ResilienceMetrics"
    ResilienceMetricsSample:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        metrics:
          $ref: "#/components/schemas/ResilienceMetrics"
      example:
        timestamp: "2026-01-11T01:00:00Z"
        metrics:
          openCount: 1
          halfOpenCount: 0
          closedCount: 5
          retryAttempts: 3
    ResilienceHistoryResponse:
      type: object
      properties:
        total:
          type: integer
        page:
          type: integer
        perPage:
          type: integer
        items:
          type: array
          items:
            $ref: "#/components/schemas/ResilienceMetricsSample"
    ResilienceAlertRuleRequest:
      type: object
      properties:
        name:
          type: string
        openThreshold:
          type: integer
        retryThreshold:
          type: integer
        windowMinutes:
          type: integer
        severity:
          type: string
          enum: [warning, critical]
      example:
        name: retry-spike
        openThreshold: 3
        retryThreshold: 10
        windowMinutes: 60
        severity: warning
    ResilienceAlertRuleUpdate:
      type: object
      properties:
        name:
          type: string
        openThreshold:
          type: integer
        retryThreshold:
          type: integer
        windowMinutes:
          type: integer
        severity:
          type: string
          enum: [warning, critical]
        enabled:
          type: boolean
    ResilienceAlertRule:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        openThreshold:
          type: integer
        retryThreshold:
          type: integer
        windowMinutes:
          type: integer
        severity:
          type: string
          enum: [warning, critical]
        enabled:
          type: boolean
      example:
        id: rule-1
        name: retry-spike
        openThreshold: 3
        retryThreshold: 10
        windowMinutes: 60
        severity: warning
        enabled: true
    ResilienceAlertRuleSummary:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        openThreshold:
          type: integer
        retryThreshold:
          type: integer
        windowMinutes:
          type: integer
        severity:
          type: string
          enum: [warning, critical]
        enabled:
          type: boolean
        recentEvents:
          type: array
          items:
            $ref: "#/components/schemas/ResilienceAlertEvent"
    ResilienceAlertEvent:
      type: object
      properties:
        id:
          type: string
        ruleId:
          type: string
        message:
          type: string
        severity:
          type: string
          enum: [warning, critical]
        triggeredAt:
          type: string
          format: date-time
        openDelta:
          type: integer
        retryDelta:
          type: integer
        acknowledged:
          type: boolean
        acknowledgedAt:
          type: string
          format: date-time
      example:
        id: event-1
        ruleId: rule-1
        message: Alert 'retry-spike' triggered: open/hr=0, retry/hr=12.
        severity: warning
        triggeredAt: "2026-01-11T01:05:00Z"
        openDelta: 0
        retryDelta: 12
        acknowledged: false
    ProviderEvent:
      type: object
      properties:
        eventType:
          type: string
        timestamp:
          type: string
          format: date-time
        message:
          type: string
        metadata:
          type: object
